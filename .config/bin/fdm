#!/bin/bash

# A really simple 'display manager' with hardcoded options.
# not actually a display manager, because it just runs after
# you manually login using the normal tty.
# powered by fzf

LINE_UP="\033[1A"
CLEAR_LINE="\033[K"
BLUE="\e[34m"
MAGENTA="\e[35m"
RED="\e[31m"
YELLOW="\e[33m"
GREEN="\e[32m"
BOLD="\e[1m"
RESET_FMT="\e[0m"
PREFERRED_SHELL="fish"

wayland_env_vars() {
    export _JAVA_AWT_WM_NONREPARENTING=1
    export MOZ_ENABLE_WAYLAND=1
    # export QT_QPA_PLATFORM=wayland-egl
    export QT_STYLE_OVERRIDE=adwaita
    # needed for Gnome Shell and Plasma Shell
    export XDG_SESSION_TYPE=wayland

    # https://wiki.archlinux.org/index.php/GNOME/Keyring#xinitrc_method
    eval $(/usr/bin/gnome-keyring-daemon --start --components=pkcs11,secrets,ssh)
    export SSH_AUTH_SOCK
}

unset_wayland_env_vars() {
    unset _JAVA_AWT_WM_NONREPARENTING
    unset MOZ_ENABLE_WAYLAND
    unset QT_QPA_PLATFORM
    unset QT_STYLE_OVERRIDE
    unset XDG_SESSION_TYPE
}

start_sway() {
    wayland_env_vars
    is_in_vm && export WLR_NO_HARDWARE_CURSORS=1
    systemd-cat -t sway sway
    unset_wayland_env_vars
}

start_sway_nouveau() {
    sudo modprobe nouveau
    start_sway
    kill_discrete_gpu
}

main_menu() {
    echo -e "${BLUE}Launch:${RESET_FMT}"

    options="sway
sway (with nouveau)
gnome (wayland)
gnome (wayland, with nouveau)
gnome (on xorg)
gnome (on xorg, with nouveau)
gnome (on xorg, nvidia drivers)
plasma (wayland)
plasma (wayland, with nouveau)
plasma (on xorg)
plasma (on xorg, with nouveau)
plasma (on xorg, nvidia drivers)
i3 (on xorg)
i3 (on xorg, nvidia drivers)
exit to virtual console
poweroff
reboot
suspend
logout"
    selection=$(echo "$options" | fzf --reverse --height=20 --color=16 )
    echo -en "$LINE_UP$CLEAR_LINE"
    case "$selection" in
        'sway')
            echo -e "${GREEN}Starting Sway...${RESET_FMT}"
            start_sway
            echo -en "$LINE_UP$CLEAR_LINE"
            ;;
        'sway (with nouveau)')
            echo -e "${GREEN}Starting Sway with Nouveau...${RESET_FMT}"
            start_sway_nouveau
            echo -en "$LINE_UP$CLEAR_LINE"
            ;;
        'gnome (wayland)')
            echo -e "${GREEN}Starting Gnome Shell...${RESET_FMT}"
            wayland_env_vars
            systemd-cat -t gnome-session dbus-run-session gnome-session
            unset_wayland_env_vars
            echo -en "$LINE_UP$CLEAR_LINE"
            ;;
        'gnome (wayland, with nouveau)')
            echo -e "${GREEN}Starting Gnome Shell with Nouveau...${RESET_FMT}"
            sudo modprobe nouveau
            wayland_env_vars
            systemd-cat -t gnome-session dbus-run-session gnome-session
            unset_wayland_env_vars
            kill_discrete_gpu
            echo -en "$LINE_UP$CLEAR_LINE"
            ;;
        'gnome (on xorg)')
            systemd-cat -t xorg startx ~/.config/environments/xinitrc-gnome
            ;;
        'gnome (on xorg, with nouveau)')
            sudo modprobe nouveau
            systemd-cat -t xorg startx ~/.config/environments/xinitrc-gnome
            kill_discrete_gpu
            ;;
        'gnome (on xorg, nvidia drivers)')
            nvidia-xrun ~/.config/environments/xinitrc-gnome
            ;;
        'plasma (wayland)')
            echo -e "${GREEN}Starting KDE Plasma...${RESET_FMT}"
            wayland_env_vars
            systemd-cat -t plasma dbus-run-session startplasma-wayland
            unset_wayland_env_vars
            echo -en "$LINE_UP$CLEAR_LINE"
            ;;
        'plasma (wayland, with nouveau)')
            echo -e "${GREEN}Starting KDE Plasma...${RESET_FMT}"
            sudo modprobe nouveau
            wayland_env_vars
            systemd-cat -t plasma dbus-run-session startplasma-wayland
            unset_wayland_env_vars
            kill_discrete_gpu
            echo -en "$LINE_UP$CLEAR_LINE"
            ;;
        'plasma (on xorg)')
            systemd-cat -t xorg startx ~/.config/environments/xinitrc-plasma
            ;;
        'plasma (on xorg, with nouveau)')
            sudo modprobe nouveau
            systemd-cat -t xorg startx ~/.config/environments/xinitrc-plasma
            kill_discrete_gpu
            ;;
        'plasma (on xorg, nvidia drivers)')
            nvidia-xrun ~/.config/environments/xinitrc-plasma
            ;;
        'i3 (on xorg)')
            systemd-cat -t xorg startx ~/.config/environments/xinitrc-i3
            ;;
        'i3 (on xorg, nvidia drivers)')
            nvidia-xrun ~/.config/environments/xinitrc-i3
            ;;
        "poweroff")
            poweroff
            ;;
        "suspend")
            systemctl suspend
            ;;
        "reboot")
            reboot_chooser
            echo -en "$LINE_UP$CLEAR_LINE"
            ;;
        "logout")
            exit
            ;;
        "exit to virtual console" | *)
            clear
            $PREFERRED_SHELL
            clear
            ;;
    esac

}

if [ "$1" == '--auto' ]; then
    start_sway
else
    while :
    do
        main_menu
    done
fi
