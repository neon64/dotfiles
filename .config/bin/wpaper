#!/bin/bash

BLUE="\e[34m"
MAGENTA="\e[35m"
RED="\e[31m"
YELLOW="\e[33m"
GREEN="\e[32m"
BOLD="\e[1m"
RESET_FMT="\e[0m"

wallpapers_dir="$(xdg-user-dir PICTURES)/wallpapers"

echo -e "${BLUE}Select a new wallpaper:${RESET_FMT}"
mkdir -p "$wallpapers_dir"
wallpaper=$(cd "$wallpapers_dir" && find . -type f | sed 's/^\.\///g'| grep -v "wallpaper-current" | fzf --reverse --height=10 --min-height=5 --color=16)

if [ "$wallpaper" = '' ]; then
    echo "No wallpaper selected, aborting..."
    exit 1
fi

wallpaper="$wallpapers_dir/$wallpaper"
ln -sf $wallpaper "$wallpapers_dir/wallpaper-current.jpg" && echo "'wallpaper-current.jpg' points to '$wallpaper'"

# note, this only supports a single output
generate_lockscreen() {
    echo -e "${GREEN}Generating lockscreen background...${RESET_FMT}"
    text="Type password to unlock..."
    dest=~/.local/share/swaylock_bg.jpg
    width=$(swaymsg -t get_outputs --raw | jq -r ".[0].current_mode.width | tostring")
    height=$(swaymsg -t get_outputs --raw | jq -r ".[0].current_mode.height | tostring")
    textheight=`expr $height / 3`
    dimensions="${width}x${height}^"
    echo "Using dimensions $dimensions, placing text at y=$textheight"
    convert "$wallpapers_dir/wallpaper-current.jpg" -resize "$dimensions" -quality 95 -blur 40x20 -font /usr/share/fonts/cantarell/Cantarell-Light.otf -pointsize 36 -fill white -gravity Center -draw "text 0,${textheight} '$text'" $dest
    echo -e "Done"
}

generate_lockscreen

swaymsg reload
